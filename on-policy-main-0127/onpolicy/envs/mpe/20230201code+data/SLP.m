function [t_result,UBnew]=SLP(s,a,M,NCG,CG,Cnode,PD,QD,w,R,X)
t=binvar(7,1);
AL=[25 29;18 33;8 21;12 22;9 15;5 6;12 13];
SL=[15 25;9 22];

%%  PL QL IL setting I 电流平方
P_l=sdpvar(37,1);Q_l=sdpvar(37,1);I_l=sdpvar(37,1);   %P,Q,I on the lines
PL=[0	P_l(1,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	P_l(2,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(19,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	P_l(3,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(25,1)	0	0	0	0	0	0	0	0	0	0
0	0	0	0	P_l(4,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	P_l(5,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	P_l(6,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(28,1)	0	0	0	0	0	0	0
0	0	0	0	0	0	0	P_l(7,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	P_l(8,1)	0	0	0	0	0	0	0	0	0	0	0	P_l(21,1)	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	P_l(9,1)	0	0	0	0	P_l(14,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	P_l(10,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	P_l(11,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	P_l(12,1)	0	0	0	0	0	0	0	0	P_l(23,1)	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(13,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(15,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(16,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(17,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(18,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(36,1)
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(20,1)	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(22,1)	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(24,1)	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(26,1)	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(27,1)	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(31,1)	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(29,1)	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(30,1)	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(32,1)	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(33,1)	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(34,1)	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(35,1)	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_l(37,1)
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0];
QL=[0	Q_l(1,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	Q_l(2,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(19,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	Q_l(3,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(25,1)	0	0	0	0	0	0	0	0	0	0
0	0	0	0	Q_l(4,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	Q_l(5,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	Q_l(6,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(28,1)	0	0	0	0	0	0	0
0	0	0	0	0	0	0	Q_l(7,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	Q_l(8,1)	0	0	0	0	0	0	0	0	0	0	0	Q_l(21,1)	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	Q_l(9,1)	0	0	0	0	Q_l(14,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	Q_l(10,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	Q_l(11,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	Q_l(12,1)	0	0	0	0	0	0	0	0	Q_l(23,1)	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(13,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(15,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(16,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(17,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(18,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(36,1)
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(20,1)	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(22,1)	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(24,1)	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(26,1)	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(27,1)	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(31,1)	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(29,1)	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(30,1)	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(32,1)	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(33,1)	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(34,1)	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(35,1)	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_l(37,1)
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0];
IL=[0	I_l(1,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	I_l(2,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(19,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	I_l(3,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(25,1)	0	0	0	0	0	0	0	0	0	0
0	0	0	0	I_l(4,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	I_l(5,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	I_l(6,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(28,1)	0	0	0	0	0	0	0
0	0	0	0	0	0	0	I_l(7,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	I_l(8,1)	0	0	0	0	0	0	0	0	0	0	0	I_l(21,1)	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	I_l(9,1)	0	0	0	0	I_l(14,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	I_l(10,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	I_l(11,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	I_l(12,1)	0	0	0	0	0	0	0	0	I_l(23,1)	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(13,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(15,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(16,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(17,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(18,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(36,1)
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(20,1)	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(22,1)	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(24,1)	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(26,1)	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(27,1)	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(31,1)	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(29,1)	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(30,1)	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(32,1)	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(33,1)	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(34,1)	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(35,1)	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	I_l(37,1)
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0];



%%  Island without CG
NCnode=[13;14;15;16;17;18];

%% PDG QDG PSOP QSOP PG QG U settings   U 电压平方
P_g=sdpvar(1,1);Q_g=sdpvar(1,1);
P_dg=sdpvar(2,1);Q_dg=sdpvar(2,1);
P_sop=sdpvar(4,1);Q_sop=sdpvar(4,1);
U=sdpvar(33,1);
PDG=[0	0	0	0	0	0	0	0	0	P_dg(1,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	P_dg(2,1)	0	0];
QDG=[0	0	0	0	0	0	0	0	0	Q_dg(1,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	Q_dg(2,1)	0	0];
PSOP=[0	0	0	0	0	0	0	0	P_sop(1,1)	0	0	0	0	0	P_sop(2,1)	0	0	0	0	0	0	P_sop(3,1)	0	0	P_sop(4,1)	0	0	0	0	0	0	0	0];
QSOP=[0	0	0	0	0	0	0	0	Q_sop(1,1)	0	0	0	0	0	Q_sop(2,1)	0	0	0	0	0	0	Q_sop(3,1)	0	0	Q_sop(4,1)	0	0	0	0	0	0	0	0];
PG=[P_g	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0];
QG=[Q_g	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0];
%%   Lstate, BB settings
L=binvar(7,1);  %Line state
% L=sdpvar(7,1); 
Lstate=[0	1	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	1	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	1	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	0	0	0
0	0	0	0	1	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	L(6,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	1	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0
0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	0	0	0	0	L(3,1)	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	1	0	0	0	0	L(5,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	L(7,1)	0	0	0	0	0	0	0	0	L(4,1)	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	L(2,1)
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	L(1,1)	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0];

B1=binvar(37,1);
B2=binvar(37,1);
% B1=sdpvar(37,1);
% B2=sdpvar(37,1);
BB1=[0	B1(1,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	B1(2,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(19,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	B1(3,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(25,1)	0	0	0	0	0	0	0	0	0	0
0	0	0	0	B1(4,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	B1(5,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	B1(6,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(28,1)	0	0	0	0	0	0	0
0	0	0	0	0	0	0	B1(7,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	B1(8,1)	0	0	0	0	0	0	0	0	0	0	0	B1(21,1)	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	B1(9,1)	0	0	0	0	B1(14,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	B1(10,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	B1(11,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	B1(12,1)	0	0	0	0	0	0	0	0	B1(23,1)	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	B1(13,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(15,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(16,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(17,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(18,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(36,1)
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(20,1)	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(22,1)	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(24,1)	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(26,1)	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(27,1)	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(31,1)	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(29,1)	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(30,1)	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(32,1)	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(33,1)	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(34,1)	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(35,1)	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B1(37,1)
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0];

BB2=[0	B2(1,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	B2(2,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(19,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	B2(3,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(25,1)	0	0	0	0	0	0	0	0	0	0
0	0	0	0	B2(4,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	B2(5,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	B2(6,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(28,1)	0	0	0	0	0	0	0
0	0	0	0	0	0	0	B2(7,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	B2(8,1)	0	0	0	0	0	0	0	0	0	0	0	B2(21,1)	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	B2(9,1)	0	0	0	0	B2(14,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	B2(10,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	B2(11,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	B2(12,1)	0	0	0	0	0	0	0	0	B2(23,1)	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	B2(13,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(15,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(16,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(17,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(18,1)	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(36,1)
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(20,1)	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(22,1)	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(24,1)	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(26,1)	0	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(27,1)	0	0	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(31,1)	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(29,1)	0	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(30,1)	0	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(32,1)	0	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(33,1)	0	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(34,1)	0	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(35,1)	0
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	B2(37,1)
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0];
BB=BB1+BB2';

%% 
Root=binvar(33,1);
R_real=Root.*CG;
R_virtual=Root.*NCG;

d=binvar(33,1);   %Load connection indicatora=binvar(7,1);  %%%%%attacker 变量
%%  Objective function
g=-sum(d.*w.*PD);   %

%%  topology related constraints
F=[];
F=[F,-1e-3<=33-sum(R_real)-sum(R_virtual)-sum(sum(Lstate))<=1e-3,sum(Root)==sum(R_real)+sum(R_virtual)];   %constraint (11);,sum(Root)>=3
% F=[F,0<=s<=1,norm([s-0.5])<=sqrt(0.5),0<=d<=1,norm([d-0.5])<=sqrt(33/4),0<=L<=1,norm([L-0.5])<=sqrt(7/4),0<=B1<=1,norm([B1-0.5])<=sqrt(37/4),0<=B2<=1,norm([B2-0.5])<=sqrt(37/4)];
F=[F,Root(9)<=s(1),Root(15)<=s(2)];
F=[F,L==t,t<=(1-a)];
for i=1:33
    F=[F,sum(BB(i,:))<=1];   %constraint (7);
%     F=[F,(1-sum(BB(:,i)))<=M*(1-R(i))];   %constraint (34);
    F=[F,1-1e-3<=sum(BB(i,:))+Root(i)<=1+1e-3];
    F=[F,1-M*(1-R_real(i))<=U(i)<=1+M*(1-R_real(i))];    
%         ,sum(BB(i,:))<=M*(1-R_virtual(i))];   %constraint (35);
%     F=[F,sum(BB(:,i))+sum(BB(i,:))<=M*(1-R_virtual(i))];   %constraint (36);
%     F=[F,0.9-M*(R_real(i)+R_virtual(i))<=sum(BB(i,:))<=1.1+M*(R_real(i)+R_virtual(i))];   %constraint (37);
%   F=[F,1+M*(1-R_real(i))>=U(i,1)>=1-M*(1-R_real(i)),M*(1-R_virtual(i))>=U(i,1)>=M*(1-R_virtual(i))];
end
F=[F,-M*(1-R_virtual(13))<=d(NCnode)<=M*(1-R_virtual(13))];
for i=1:32
   for j=(i+1):33
        F=[F,1e-3>=BB(i,j)+BB(j,i)-Lstate(i,j)>=-1e-3];
    end
end


%%  Power flow related constraints
% F=[F,0.93^2<=U<=1.07^2];  %%% U,(Cnode) d at buses   d<=(1-R_virtual),
F=[F,0.93^2-0.93^2*R_virtual(13)<=U(NCnode)<=1.07^2+1.07^2*R_virtual(13),0.93^2<=U(Cnode)<=1.07^2];  %%%voltage constraints
F=[F,0<=P_dg<=0.02,-0.9*P_dg<=Q_dg<=0.9*P_dg,norm([P_dg(1,1),Q_dg(1,1)])<=0.05,norm([P_dg(2,1),Q_dg(2,1)])<=0.05];   %DG related constraints;  

for i=1:size(s,1)   %SOP related constraints
F=[F,-1e-3<=1.05*PSOP(SL(i,1))+1.05*PSOP(SL(i,2))<=1e-3,...
    -s(i)*0.003<=QSOP(SL(i,1))<=s(i)*0.003,-s(i)*0.003<=QSOP(SL(i,2))<=s(i)*0.003,...
    -s(i)*0.005<=PSOP(SL(i,1))<=s(i)*0.005,-s(i)*0.005<=PSOP(SL(i,2))<=s(i)*0.005,...
    norm([PSOP(SL(i,1)),QSOP(SL(i,1))])<=0.006, norm([PSOP(SL(i,2)),QSOP(SL(i,2))])<=0.006];
end
F=[F,-0.01<=P_g<=0.01,-0.01<=Q_g<=0.01];   %G related constraints 
%%%%%%%%%%%%%% constraints for P Q I on the lines; 
F=[F,-M*Lstate<=PL<=M*Lstate,-M*Lstate<=QL<=M*Lstate,0<=IL<=M*Lstate,IL<=0.01];   %G related constraints
for i=1:33
    F=[F,-1e-3<=sum(PL(:,i)-R(:,i).*IL(:,i))+PG(i)+PDG(i)+PSOP(i)-d(i)*PD(i)-sum(PL(i,:))<=1e-3,...
         -1e-3<=sum(QL(:,i)-X(:,i).*IL(:,i))+QG(i)+QDG(i)+QSOP(i)-d(i)*QD(i)-sum(QL(i,:))<=1e-3]
end
for i=1:32
   for j=(i+1):33
        F=[F,-1e-3<=U(j)-2*(R(i,j)*PL(i,j)+X(i,j)*QL(i,j))+(R(i,j)^2+X(i,j)^2)*IL(i,j)-U(i)<=1e-3,...
            norm([2*PL(i,j),2*QL(i,j),(U(i)-IL(i,j))])<=(U(i)+IL(i,j))];
    end
end

%% optimization 
% options=sdpsettings('solver','intlinprog');,sdpsettings('solver','gurobi')
optimize(F,g,sdpsettings('solver','gurobi'));
t_result=value(t);
UBnew=value(g);